<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Healthcare Test Result Prediction</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
  body { font-family: "Segoe UI", Roboto, Arial; background:#f4f7fb; color:#222; padding:30px;}
  .card { max-width:1000px; margin:auto; background:white; padding:20px; border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,0.08);}
  h1 { margin-top:0; }
  .grid { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
  label { font-size:0.9rem; color:#444; }
  input, select { width:100%; padding:8px 10px; margin-top:6px; border-radius:6px; border:1px solid #ccc; }
  .full { grid-column:1/-1; }
  button { padding:10px 16px; border-radius:6px; border:none; background:#007bff; color:#fff; font-weight:600; cursor:pointer; }
  button.secondary { background:#6c757d; }
  .result { padding:12px; border-radius:8px; margin-top:12px; font-weight:700; }
  .result.normal { background:#e6fff2; color:#046b2f; }
  .result.abnormal { background:#fff1f0; color:#8b0000; }
  .result.inconclusive { background:#fff8e6; color:#7a5c00; }
  table { width:100%; border-collapse:collapse; margin-top:12px; }
  th, td { padding:8px 10px; border-bottom:1px solid #eee; text-align:left; }
  .presets { display:flex; gap:8px; margin-bottom:8px; }
</style>
</head>
<body>
  <div class="card">
    <h1>Healthcare Test Result Prediction</h1>
    <p>Fill the fields or use quick presets. You can also upload a CSV for batch predictions. The backend must be running at <code>http://127.0.0.1:8000</code>.</p>

    <div class="presets">
      <button onclick="fillPreset('normal')">Preset — Likely Normal</button>
      <button onclick="fillPreset('abnormal')">Preset — Likely Abnormal</button>
      <button onclick="fillPreset('inconclusive')">Preset — Likely Inconclusive</button>
    </div>

    <div class="grid">
      <div>
        <label>Age</label>
        <input id="Age" type="number" value="35">
      </div>
      <div>
        <label>Gender (0 = Female, 1 = Male)</label>
        <input id="Gender" type="number" min="0" max="1" value="0">
      </div>
      <div>
        <label>Blood Type (encoded)</label>
        <input id="Blood_Type" type="number" value="1">
      </div>
      <div>
        <label>Medical Condition (encoded)</label>
        <input id="Medical_Condition" type="number" value="0">
      </div>
      <div>
        <label>Billing Amount</label>
        <input id="Billing_Amount" type="number" value="12000">
      </div>
      <div>
        <label>Admission Type (encoded)</label>
        <input id="Admission_Type" type="number" value="0">
      </div>
      <div>
        <label>Medication (encoded)</label>
        <input id="Medication" type="number" value="0">
      </div>
      <div>
        <label>Symptom Severity (0–10)</label>
        <input id="Symptom_Severity" type="number" min="0" max="10" value="1">
      </div>
      <div>
        <label>Prior Hospital Visits</label>
        <input id="Prior_Hospital_Visits" type="number" value="0">
      </div>
      <div>
        <label>High BP Flag (0/1)</label>
        <input id="High_BP_Flag" type="number" min="0" max="1" value="0">
      </div>
      <div>
        <label>High Sugar Flag (0/1)</label>
        <input id="High_Sugar_Flag" type="number" min="0" max="1" value="0">
      </div>
      <div>
        <label>Fever Flag (0/1)</label>
        <input id="Fever_Flag" type="number" min="0" max="1" value="0">
      </div>
      <div class="full">
        <label>Risk Score</label>
        <input id="Risk_Score" type="number" value="11">
      </div>

      <div class="full" style="display:flex; gap:8px">
        <button onclick="predict()" style="flex:1">Predict</button>
        <input id="fileInput" type="file" accept=".csv" style="flex:1">
        <button class="secondary" onclick="uploadCSV()" style="flex:1">Upload CSV & Predict</button>
      </div>

      <div id="resultBox" class="full" style="display:none"></div>
      <div id="batchArea" class="full" style="display:none">
        <h3>Batch Predictions</h3>
        <a id="downloadLink" href="#" style="display:none">Download Predictions CSV</a>
        <div id="tableDiv"></div>
      </div>
    </div>
  </div>

<script>
const API_BASE = "http://127.0.0.1:8000";

function fillPreset(kind) {
  if (kind === 'normal') {
    document.getElementById('Age').value = 30;
    document.getElementById('Gender').value = 0;
    document.getElementById('Symptom_Severity').value = 1;
    document.getElementById('Risk_Score').value = 10;
    document.getElementById('Billing_Amount').value = 5000;
    document.getElementById('Prior_Hospital_Visits').value = 0;
  } else if (kind === 'abnormal') {
    document.getElementById('Age').value = 65;
    document.getElementById('Gender').value = 1;
    document.getElementById('Symptom_Severity').value = 9;
    document.getElementById('Risk_Score').value = 80;
    document.getElementById('Billing_Amount').value = 90000;
    document.getElementById('Prior_Hospital_Visits').value = 6;
    document.getElementById('High_BP_Flag').value = 1;
    document.getElementById('High_Sugar_Flag').value = 1;
  } else {
    // inconclusive
    document.getElementById('Age').value = 45;
    document.getElementById('Symptom_Severity').value = 4;
    document.getElementById('Risk_Score').value = 40;
    document.getElementById('Billing_Amount').value = 30000;
    document.getElementById('Prior_Hospital_Visits').value = 1;
  }
}

async function predict() {
  const payload = {
    Age: parseFloat(document.getElementById('Age').value),
    Gender: parseInt(document.getElementById('Gender').value),
    Blood_Type: parseInt(document.getElementById('Blood_Type').value),
    Medical_Condition: parseInt(document.getElementById('Medical_Condition').value),
    Billing_Amount: parseFloat(document.getElementById('Billing_Amount').value),
    Admission_Type: parseInt(document.getElementById('Admission_Type').value),
    Medication: parseInt(document.getElementById('Medication').value),
    Symptom_Severity: parseFloat(document.getElementById('Symptom_Severity').value),
    Prior_Hospital_Visits: parseInt(document.getElementById('Prior_Hospital_Visits').value),
    High_BP_Flag: parseInt(document.getElementById('High_BP_Flag').value),
    High_Sugar_Flag: parseInt(document.getElementById('High_Sugar_Flag').value),
    Fever_Flag: parseInt(document.getElementById('Fever_Flag').value),
    Risk_Score: parseFloat(document.getElementById('Risk_Score').value)
  };

  try {
    const res = await fetch(API_BASE + "/predict", {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || JSON.stringify(data));
    showResult(data);
  } catch (err) {
    alert("Error: " + err.message);
  }
}

function showResult(data) {
  const box = document.getElementById('resultBox');
  box.style.display = 'block';
  box.className = 'result full';
  const label = (data.prediction_label || data.prediction || data.prediction_encoded);
  if (label.toLowerCase && label.toLowerCase().includes('normal')) {
    box.classList.add('normal'); box.innerHTML = "Prediction: NORMAL ✔️";
  } else if (label.toLowerCase && label.toLowerCase().includes('abnormal')) {
    box.classList.add('abnormal'); box.innerHTML = "Prediction: ABNORMAL ❗";
  } else {
    box.classList.add('inconclusive'); box.innerHTML = "Prediction: INCONCLUSIVE ❓";
  }
}

// Batch CSV upload
async function uploadCSV() {
  const fileInput = document.getElementById('fileInput');
  if (!fileInput.files[0]) { alert("Attach a CSV file first."); return; }

  const form = new FormData();
  form.append('file', fileInput.files[0]);

  try {
    const res = await fetch(API_BASE + "/predict_batch", { method: "POST", body: form });
    const data = await res.json();
    if (!res.ok) throw new Error(data.detail || JSON.stringify(data));
    showBatchResults(data);
  } catch (err) {
    alert("Batch error: " + err.message);
  }
}

function showBatchResults(payload) {
  document.getElementById('batchArea').style.display = 'block';
  const csv = payload.content;
  const filename = payload.filename || 'predictions.csv';
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = URL.createObjectURL(blob);
  const dl = document.getElementById('downloadLink');
  dl.href = url; dl.download = filename; dl.style.display = 'inline';
  // Render top 20 rows
  const rows = csv.split('\n').slice(0,21).map(r => r.split(','));
  let html = "<table><thead><tr>" + rows[0].map(h => "<th>"+h+"</th>").join('') + "</tr></thead><tbody>";
  for (let i=1;i<rows.length;i++) { html += "<tr>" + rows[i].map(c => "<td>"+(c||'')+"</td>").join('') + "</tr>"; }
  html += "</tbody></table>";
  document.getElementById('tableDiv').innerHTML = html;
}
</script>
</body>
</html>
